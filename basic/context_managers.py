"""
    Контекстные менеджеры — это инструмент в Python, позволяющий гарантировать выполнение
    определённых действий при входе и выходе из блока кода, даже если в этом блоке произойдёт исключение.
    Наиболее распространённый способ использования — оператор with.
    Контекстные менеджеры обеспечивают безопасную работу с ресурсами: файлы, соединения, блокировки и т.д.
"""

"""
    1 - базовое использование with
    2 - как работают контекстные менеджерыё
    3 - контекстный менеджер при работе с исключениями
    4 - модуль contextlib
    5 - практические примеры
"""

### 1 - базовое использование with
"""
    Оператор with используется для работы с контекстными менеджерами.
    Синтаксис: 
    with выражение as переменная:
        тело блока
"""
# Пример: работа с файлами
with open("example.txt", "w") as f:
    f.write("Привет, мир!")
# Файл автоматически закрывается после выхода из блока with, даже если произошло исключение

### 2 - как работают контекстные менеджеры
"""
    Контекстный менеджер должен реализовывать два специальных метода:
    - __enter()__ — вызывается при входе в блок with
    - __exit()__ — вызывается при выходе из блока with
"""

# Пример: собственный контекстный менеджер
class MyContextManager:
    def __enter__(self):
        print("Вход в контекстный менеджер")
        return self # возвращаем объект, который будет присвоен переменной после as

    def __exit__(self, exc_type, exc_value, traceback):
        print("Выход из контекстного менеджера")
        if exc_type:
            print(f"Произошло исключение: {exc_type.__name__}: {exc_value}")
        return False  # если возвращается True, исключение подавляется

# Использование
with MyContextManager() as cm:
    print("Выполняется в контексте")
    # raise ValueError("Ошибка!") # раскомментировать для теста исключения

### 3 - контекстный менеджер при работе с исключениями
"""
    Метод __exit__ может обрабатывать исключения:
    - Если возвращается True, исключение подавляется
    - Если возвращается False или None, исключение продолжает распространяться
"""

class SuppressErrors:
    def __enter__(self):
        return self

    def __exit__(self, exc_type, exc_value, traceback):
        if exc_type:
            print(f"Исключение подавлено: {exc_type.__name__}")
        return True  # подавляем исключение

with SuppressErrors():
    print("Без ошибок")
    raise ValueError("Это исключение будет подавлено")

print("Программа продолжает выполнение")

### 4 - модуль contextlib
"""
    Модуль contextlib предоставляет удобные инструменты для создания контекстных менеджеров:
    - @contextmanager — декоратор для создания контекстного менеджера из генератора
    - contextlib.closing() — оборачивает объект с методом close()
"""
from contextlib import contextmanager, closing

# Пример: контекстный менеджер через @contextmanager
@contextmanager
def my_context():
    print("Вход в контекст")
    try:
        yield "Ресурс" # возвращается в as переменную
    finally:
        print("Выход из контекста")

with my_context() as resource:
    print(f"Работаем с {resource}")

# Пример: contextlib.closing()
class MyResource:
    def close(self):
        print("Ресурс закрыт")

with closing(MyResource()) as res:
    pass # ресурс будет закрыт автоматически

### 5 - практические примеры
"""
    Контекстные менеджеры часто используются для:
    - Работы с файлами
    - Управления транзакциями в БД
    - Блокировок (locks)
    - Временного изменения состояния
"""

# Пример: безопасная работа с файлом
filename = "test.txt"
try:
    with open(filename, "r") as f:
        content = f.read()
        print(content)
except FileNotFoundError:
    print(f"Файл {filename} не найден")

# Пример: временные изменения (например, смена директории)
import os
from contextlib import contextmanager

@contextmanager
def change_dir(destination):
    try:
        cwd = os.getcwd()
        os.chdir(destination)
        yield
    finally:
        os.chdir(cwd)

with change_dir("/tmp"):
    print(os.getcwd()) # /tmp

print(os.getcwd()) # возвращаемся в исходную директорию

"""
    Основные особенности контекстных менеджеров:
    1. Обеспечивают безопасную работу с ресурсами.
    2. Используют оператор `with` для определения области действия.
    3. Реализуются через методы `__enter__` и `__exit__`.
    4. Могут автоматически освобождать ресурсы и обрабатывать исключения.
    5. Позволяют создавать гибкие и безопасные абстракции.
    6. Модуль `contextlib` упрощает создание собственных менеджеров.
"""



